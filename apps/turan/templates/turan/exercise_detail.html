{% extends "turan/base.html" %}
{% load i18n %}
{% load turan_extras %}
{% load humanize %}
{% load l10n %}
{% load tagging_tags %}
{% load avatar_tags %}

{% block title %}
{{block.super}}
 {{ object }}, {{ object.date }}
{% endblock %}
{% block searchenginemeta %}
{% tags_for_object object as tag_list %}
{% endblock %}
{% block extra_head %}
{{ block.super }}
     <script type="text/javascript" src="{{MEDIA_URL}}turan/flot/jquery.flot.crosshair.js"></script>
{% with object.route.gpx_file as gpx_file %}
     {% include "turan/maphead.html" %}
{% endwith %}
{% endblock %}
{% block content %}

        <div class="content">
            <div class="page-header">
                <div class="floatright" itemprop="performers" itemscope itemtype="http://schema.org/Person">
                    <a itemprop="url" href="{{object.user.get_profile.get_absolute_url }}">
                        {% avatar object.user 40 %}
                    </a>
                    <meta itemprop="name" content="{{ object.user.username }}" />
                </div>
                <div class="btn-group floatright">
                    <a class="btn" href="{% url exercise_player %}?id={{object.id }}">
                        <img alt="Play" title="{% trans "Play exercise" %}" src="{{ "control_play"|silk_icon }}">
                        {% trans "Play" %}
                    </a>
                    {% if user == object.user %}
                    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="{% url exercise_update object.id %}">
                                <img alt="modify" title="{% trans "Modify exercise" %}" src="{{ "wrench"|silk_icon }}"> {% trans "Modify" %}
                            </a>
                        </li>
                        <li>
                            <a href="{% url exercise_delete object.id %}">
                                <img alt="delete" title="{% trans "Delete exercise" %}" src="{{ "cross"|silk_icon }}"> {% trans "Delete" %}
                            </a>
                        </li>
                    {% endif%}
                    {% if user == object.user or user.is_superuser%}
                        {% if object.sensor_file %}
                        <li class="divider"></li>
                        <li>
                            <a href="{% url exercise_parse object.id %}">
                                <img alt="modify" title="{% trans "Reparse exercise" %}" src="{{ "page_refresh"|silk_icon }}"> {% trans "Reparse" %}
                            </a>
                        </li>
                        {% endif %}
                    {% endif %}
                </div>
                <h2>
                    <img height="32" width="32" class="floatleft" style="padding: 0 2px" alt="Exerciselogo" src="{{object.icon}}" />
                    <span itemprop="name">{{ object.get_name }}</span>
                    {% ifequal object.exercise_permission "N" %}
                    <img title="{% trans "Private exercise"%}" alt="{% trans "Private exercise"%}" src="{{MEDIA_URL}}pinax/img/silk/icons/lock.png">
                    {% else %}
                    {% ifequal object.exercise_permission "F" %}
                    {% ifequal user object.user %}
                    <img title="{% trans "Exercise visible to friends"%}" alt="{% trans "Exercise visible to friends"%}" src="{{MEDIA_URL}}pinax/img/silk/icons/lock_go.png">
                    {% endifequal %}
                    {% endifequal %}
                    {% endifequal %}
                    {% ifequal user object.user %}
                    <a href="{% url exercise_update object.id %}">
                        <img alt="modify" title="{% trans "Modify exercise" %}" src="{{ "wrench"|silk_icon }}">
                    </a>
                    {% endifequal %}
                    <small>
                        {% trans "by" %}
                        <a href="{{ object.user.get_profile.get_absolute_url }}">
                            {{ object.user }}
                        </a> 
                         
                        {{ object.date|naturalday }}
                        


                </small>
            </h2>
        </div>

        <div style="clear: right" class="row">
          <div style="" class="span6">
            {% include "turan/exercise/attributes.html" %}
          </div>
          <div style="" class="span6">
            {% if object.route.gpx_file %}
            <div class="mapcontainer"><div class="map ui-widget-content" id="map"></div>
            </div>
            {% endif %}
          </div>
        </div>
        <div class="row">
          <div style="background: white" class="span12">
{% if object.sensor_file or object.live_state == 'L' %}
    <ul class="nav nav-tabs">
        <li class="active">
        <a href="#tabs-1" data-toggle="tab">
                <img alt="Graph" src="{{MEDIA_URL}}pinax/img/silk/icons/chart_curve.png">{% trans "Graph" %}
        </a>
        </li>
        <li id="tabs-select-2">
        <a href="#tabs-2" data-toggle="tab">
            <img alt="Comments" src="{{ "comments"|silk_icon }}">
            {% trans "Comments" %}
        </a>
        </li>
        {% if intervals %}
        <li id="tabs-select-3">
        <a href="#tabs-3" data-toggle="tab">
                <img alt="Intervals" src="{{MEDIA_URL}}pinax/img/silk/icons/timeline_marker.png">
                {% trans "Intervals" %} <span class="label">{{ intervals|length }}</span>
        </a>
        </li>
        {% endif %}
        <li id="tabs-select-4">
        <a href="#tabs-4" data-toggle="tab">
                <img alt="Zones" src="{{MEDIA_URL}}pinax/img/silk/icons/chart_pie.png">
                {% trans "Zones" %}
        </a>
        </li>
        <li id="tabs-select-5">
        <a href="#tabs-5" data-toggle="tab">
                <img alt="Freqs" src="{{MEDIA_URL}}pinax/img/silk/icons/chart_bar.png">
                {% trans "Freqs" %}
        </a>
        </li>
        {% if slopes %}
        <li id="tabs-select-6">
            <a href="#tabs-6" data-toggle="tab">
                <img alt="Slopes" src="{{MEDIA_URL}}pinax/img/silk/icons/shape_rotate_clockwise.png">
                {% trans "Slopes" %} <span class="label">{{ slopes|length }}</span>
            </a>
        </li>
        {% endif %}
        {% ifequal object.exercise_type.altitude 1 %}
        <li id="tabs-select-7">
            <a href="#tabs-7" data-toggle="tab">
                <img alt="Inclinedata" src="{{MEDIA_URL}}pinax/img/silk/icons/sum.png">
                {% trans "Inclinedata" %}
            </a>
        </li>
        {% endifequal %}
        <li id="tabs-select-9">
            <a href="#tabs-9" data-toggle="tab">
                <img alt="Zones" src="{{MEDIA_URL}}pinax/img/silk/icons/table_lightning.png">
                {% trans "Best Efforts" %}
            </a>
        </li>
    </ul>

      <div id="turan-tab-content" class="tab-content ">
    <div id="tabs-1" class="active graph tab-pane">
        <div id="graphcontainer">
        {% include "turan/exercise/graph.html" %}
        </div>
    </div>

    <div id="tabs-2" class="tab-pane">
        {% if object.comment %}
        <ul>
            <li class="comment">
                {{ object.user }} {% trans "writes" %}:
                <p>{{ object.comment|linebreaks }}</p>
            </li>
        </ul>
        {% endif %}
        {% include "turan/commentform.html" %}
    </div>

    {% if intervals %}
    <div id="tabs-3" class="interval_tab tab-pane">
        <div class="page-header">
            <h1>Intervals</h1>
        </div>
        {% include "turan/exercise/interval_tab.html" %}
    </div>
    {% endif %}

    <div id="tabs-4" class="zone_tab tab-pane">
        {% include "turan/exercise/zone_tab.html" %}
    </div>

    <div id="tabs-5" class="hrhzone_tab tab-pane">
        {% include "turan/exercise/hrhzone_tab.html" %}
    </div>

    {% if slopes %}
        {% include "turan/exercise/slope_tab.html" %}
    {% endif %}

    {% ifequal object.exercise_type.altitude 1 %}
    <div id="tabs-7" class="tab-pane">
        <div id="gradientzonediv" style="width:980px;height:400px;"></div>
        {% include "turan/exercise/gradient_tab.html" %}
        {% include "turan/exercise/incline_tab.html" %}
    </div>
    {% endifequal %}

    <div id="tabs-9" class="tab-pane">
        {% include "turan/exercise/best_effort_tab.html" %}
    </div>
  </div>
<script type="text/javascript">

/*
    function selectTab(evt) {
        var id = evt.target.id ? evt.target.id : evt.target.parentNode.id;
        id = "tabs-" + id.split('-')[2];
        $('#tabs div.visible').removeClass('visible');
        $('#tabs div#' + id).addClass('visible');
        $('#tabs>ul>li').removeClass('selected');
        $(this).addClass('selected');
        if ($(this).attr("id").split('-')[0] == "tabs") {
            window.location.hash = $(this).attr("id");
        }
    }
    /*$('#tabs>ul>li').each(function () {
        $(this).bind("click", selectTab);
    });
    $('.zoom-select').each(function () {
        $(this).bind("click", selectTab);
    });
    $(window).bind("hashchange", function (evt) {
        var orly = window.location.hash.split('-')
        if (orly) {
            if (orly[0] == "#graph") {
                var x = orly[2];
                var x2 = orly[3];
                GraphPlotter.setRange({ xaxis: { from: x, to: x2 }});
                GraphPlotter.plot();
            }
            else if (orly[0] == "#tabs") {
                $(window.location.hash).trigger("click");
            }
        }
    });
    var orly = window.location.hash.split('-')
    if (orly) {
        if (orly[0] == "#tabs")
            $(window).trigger("hashchange");
            //$(window.location.hash).trigger("click");
    }

    var commentcount = $('.bulk').size();
    {% if object.comment %}
    commentcount += 1;
    {% endif %}
    */
    //$('#tabs-select-2').html('<p>{% trans "Comments" %} <span class="floatright">' + commentcount + '</span></p>');

$(document).ready(function(){
    if (Mapper.map) {
        // Init the marker for graph hover thingy
        Mapper.posLayer = Mapper.initFeature('{{object.user}}' + ' {% trans "Position" %}', "{{5|player_icon_huge:object.exercise_type}}", 48);


        {% localize off %}
        {% if object.max_speed_lat %}
            sml  = Mapper.initFeature('{{object.user}}' + ' {% trans "Max speed" %}', "{{ "lightning_go"|silk_icon }}", 16);
            feature = Mapper.createFeature(sml, {{object.max_speed_lon}}, {{object.max_speed_lat}}, 0);
/*
            var pop =  new OpenLayers.Popup.AnchoredBubble(
                '{% trans "Max speed" %}',
                new OpenLayers.LonLat(speedmaxpos.lon,speedmaxpos.lat),
                new OpenLayers.Size(64,64),
                "{% trans "Max speed"%}: "+speedmaxpos.max,
                
                true)
             popup = new OpenLayers.Popup.AnchoredBubble(null, 

              new OpenLayers.LonLat(speedmaxpos.lon,speedmaxpos.lat).transform(new OpenLayers.Projection("EPSG:4326"), Mapper.map.getProjectionObject()),

              null,

              "<div style='font-size:.8em'>Plane is flying at an angle of " + speedmaxpos.max + 

              " &deg;<br>Current position is " + Math.round(feature.geometry.x*10000)/10000 + ", " + Math.round(feature.geometry.y*10000)/10000 + "</div>",

              null,true,  function () {  } );
            */

        {% endif %}
        {% if object.max_power_lat %}
            sml  = Mapper.initFeature('{{object.user}}' + ' {% trans "Max power" %}', "{{ "lightbulb"|silk_icon }}", 16);
            Mapper.createFeature(sml, {{object.max_power_lon}}, {{object.max_power_lat}}, 0);
        {% endif %}
        {% if object.max_hr_lat %}
            sml  = Mapper.initFeature('{{object.user}}' + ' {% trans "Max HR" %}', "{{ "heart"|silk_icon }}", 16);
            Mapper.createFeature(sml, {{object.max_hr_lon}}, {{object.max_hr_lat}}, 0);
        {% endif %}
        {% if object.max_cadence_lat %}
            sml  = Mapper.initFeature('{{object.user}}' + ' {% trans "Max cadence" %}', "{{ "cog"|silk_icon }}", 16);
            Mapper.createFeature(sml, {{object.max_cadence_lon}}, {{object.max_cadence_lat}}, 0);
        {% endif %}
        {% if object.max_altitude_lat %}
            sml  = Mapper.initFeature('{{object.user}}' + ' {% trans "Max altitude" %}', "{{ "arrow_up"|silk_icon }}", 16);
            Mapper.createFeature(sml, {{object.max_altitude_lon}}, {{object.max_altitude_lat}}, 0);
        {% endif %}

        {% endlocalize %}

    }

// Make map resizable
//$('#map').resizable();

});
</script>
{% else %}
{% include "turan/commentform.html" %}
{% endif %}
          </div>
        </div>
      </div>

{% endblock%}
