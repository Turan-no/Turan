{% extends "turan/base.html" %}
{% load humanize %}
{% load i18n %}
{% load l10n %}
{% load turan_extras %}
{% block title %} {% trans "Exercise" %} {% endblock %}
{% block extra_head %}
{{ block.super }}
    <script type="text/javascript" src="{{MEDIA_URL}}turan/flot/jquery.flot.crosshair.js"></script>
{% with exercise as object %}
{% with exercise.route.gpx_file as gpx_file %}
    {% include "turan/maphead.html" %}
{% endwith %}
{% endwith %}
{% endblock %}
{% block content %}
<h1>{% trans "Playback of exercise" %} {{ exercise }}</h1>
{% include "turan/altitude_profile.html" %}
{% for object in exercises %}
<hr class="clearleft">
{{ object }}
<hr class="clearleft">
<p class="graphheader speed floatleft">{% trans "Speed" %}
<br>
<span class="title" id="speedval{{object.pk}}"></span>
</p>
<div class="graph speed floatleft drop-shadow" id="speeddiv{{object.pk}}" style="width:130px;height:40px"></div>
<p class="graphheader hr floatleft">{% trans "HR" %}<br><span class="title" id="hrval{{object.pk}}"</span></p>
<div class="graph hr floatleft drop-shadow" id="hrdiv{{object.pk}}" style="width:130px;height:40px"></div>
{% if object.max_cadence %}
<p class="graphheader cadence floatleft">{% trans "Cadence" %}<br><span class="title" id="cadenceval{{object.pk}}"</span></p>
<div class="graph cadence floatleft drop-shadow" id="cadencediv{{object.pk}}" style="width:130px;height:40px"></div>
{% endif %}
<p class="graphheader altitude floatleft">{% trans "Altitude" %}<br><span class="title" id="altitudeval{{object.pk}}"</span></p>
<div class="graph altitude floatleft drop-shadow" id="altitudediv{{object.pk}}" style="width:130px;height:40px"></div>
{% if object.avg_power %}
<p class="graphheader power floatleft">{% trans "Power" %}<br><span class="title" id="powerval{{object.pk}}"</span></p>
<div class="graph power floatleft drop-shadow" id="powerdiv{{object.pk}}" style="width:130px;height:40px"></div>
{% endif %}
{% endfor %}
<script  language="javascript" type="text/javascript">
    {% localize off %}
    var options = { 
        series: {
             lines: { show: false },
             bars: { 
                show: true,
                horizontal: true,
                fill: 1,
                barWidth: 1,
                align: "center"
             },
            xaxis: { tickDecimals: 0, tickSize: 1, tickLength: 1},
            yaxis: { tickDecimals: 0, tickSize: 1}
        },
        grid: {
            show: false,
            borderColor: '#000',
            borderWidth: 1,
            color: '#ffffff',
            markingsColor: "#000000",
            markingsLineWidth: 1,
            axisMargin: 0,
            labelMargin: 0
        }
    };

var graphoptions = [];
var datasets = [];
{% for dataset in datasets %}
datasets.push({{dataset}});
{% endfor %}
{% for object in exercises %}
    graphoptions.push( {
    {% if object.avg_hr %}
      'hr': $.extend(true, {}, options, { xaxis: {max: {{object.max_hr}}, min: 80}, grid: { markings: [ { yaxis: { from: {{object.avg_hr}}, to: {{object.avg_hr}}}}]} }),
    {% endif %}
    {% if object.avg_speed %}
     'speed': $.extend(true, {}, options, { xaxis: {max: {{object.max_speed}}, min: 0 }}),
    {% endif %}
    {% if object.max_cadence %}
     'cadence': $.extend(true, {}, options, { xaxis: {max: {{object.max_cadence}}, min: 0}}),
    {% endif %}
     'altitude': $.extend(true, {}, options, { xaxis: {max: {{alt_max}}, min: 0}}),
    {% if object.avg_power %}
     'power': $.extend(true, {}, options, { xaxis: {max: {{object.max_power}}, min: 0}})
    {% endif %}
    });
{% endfor %}

var plots = {
};
/*
        'hr' : $.plot($("#hrdiv"),{ color: 2, data: datasets['hr']['data'].slice(index-1, index)}, hroptions),
        'speed' : $.plot($("#speeddiv"),[datasets['speed']['data'].slice(index-1, index)], speedoptions),
        'cadence' : $.plot($("#cadencediv"),[datasets['cadence']['data'].slice(index-1, index)], cadenceoptions),
        'power' :$.plot($("#powerdiv"),[datasets['power']['data'].slice(index-1, index)], poweroptions)
*/
$(document).ready(function() {

    //Mapper.gsat.setVisibility(1);
    Mapper.map.setBaseLayer(Mapper.gsat);
    Mapper.lgpx.setVisibility(0);
    //Mapper.map.removeLayer(Mapper.lgpx);
    // Focus le map
    $('#mapcontainer').focus();

    var updateInterval = 500;
    var zoomLevel = 15;
    var interval = 0;
    var index = 0;
    var mapUpdater = 0;
    var iterations = datasets[0]["lon"].length;

    $('#altdiv').bind("plotclick", function (evt, pos, item) {
        index = item.dataIndex;
    });
    var lineLayers = [];
    {% for object in exercises %}
        lineLayers.push(Mapper.initLine('{{object.user}}'));
    {% endfor %}
    var updateMapAndGraph= function() {
        if (index >= iterations) {
            clearInterval(interval);
        }
        {% for object in exercises %}
            var lon = datasets[{{forloop.counter0}}]["lon"][index];
            var lat = datasets[{{forloop.counter0}}]["lat"][index];
            var p_lon = datasets[{{forloop.counter0}}]["lon"][index-1];
            var p_lat = datasets[{{forloop.counter0}}]["lat"][index-1];
            // Check for none-values, we don't want to zoom to 0_o o_0
            if (lon != 0.0 && lat != 0.0) {
                {% if forloop.first %}
                    // Only move map every 4th sample, less cluttery looking
                    if (mapUpdater >= 4) {
                        Mapper.zoomToPosMarker();
                        mapUpdater = 0;
                    }
                    Mapper.updatePosMarker(datasets[{{forloop.counter0}}]["lon"][index],datasets[{{forloop.counter0}}]["lat"][index]);
                {% endif %}
                if (p_lon != 0.0 && p_lat != 0.0) {
                    Mapper.drawLine(lineLayers[{{forloop.counter0}}], colors[{{forloop.counter}}], p_lon, p_lat, lon, lat);
                }
            }
            {% if object.avg_hr %}
            var hrval = datasets[{{forloop.counter0}}]['hr']['data'][index][1];
                $('#hrval{{object.pk}}').html(hrval);
                plots['hr'] = $.plot($("#hrdiv{{object.pk}}"),[{ 'color': 2, 'data': [[hrval, 0]]}], graphoptions[{{forloop.counter0}}]['hr']);
            {% endif %}
            {% if object.avg_speed %}
            var speedval = datasets[{{forloop.counter0}}]['speed']['data'][index][1];
                $('#speedval{{object.pk}}').html(speedval.toFixed(1));
                plots['speed'] = $.plot($("#speeddiv{{object.pk}}"),[{ 'color': 0, 'data': [[speedval, 0]]}], graphoptions[{{forloop.counter0}}]['speed']);
            {% endif %}

            var altitudeval = datasets[{{forloop.counter0}}]['altitude']['data'][index][1];
                $('#altitudeval{{object.pk}}').html(altitudeval.toFixed(0));
                plots['altitude'] = $.plot($("#altitudediv{{object.pk}}"),[{ 'color': 3, 'data': [[altitudeval, 0]]}], graphoptions[{{forloop.counter0}}]['altitude']);
            {% if object.max_cadence %}
            var cadenceval = datasets[{{forloop.counter0}}]['cadence']['data'][index][1];
                $('#cadenceval{{object.pk}}').html(cadenceval.toFixed(0));
                plots['cadence'] = $.plot($("#cadencediv{{object.pk}}"),[{ 'color': 1, 'data': [[cadenceval, 0]]}], graphoptions[{{forloop.counter0}}]['cadence']);
            {% endif %}
            {% if object.avg_power %}
            var powerval = datasets[{{forloop.counter0}}]['power']['data'][index][1];
                $('#powerval{{object.pk}}').html(powerval.toFixed(0));
                plots['power'] = $.plot($("#powerdiv{{object.pk}}"),[{ 'color': 4, 'data': [[powerval, 0]]}], graphoptions[{{forloop.counter0}}]['power']);
            {% endif %}
        {% endfor %}
            
            // Unhighlight all previous points
            altitudeprofileplot.unhighlight();
            // Highlight the point at index in the first series in the altitudeprofile plot
            altitudeprofileplot.highlight(0, index);

        index = index+1;
        mapUpdater++;
    }

    interval = setInterval(updateMapAndGraph, updateInterval);
});

{% endlocalize %}
</script>
<div class="mapcontainer"><div style="width:1000px;height:800px" class="drop-shadow raised" id="map"></div>

{% endblock content %}

