{% extends "turan/base.html" %}
{% load humanize %}
{% load i18n %}
{% load l10n %}
{% load turan_extras %}
{% block title %} {% trans "Exercise" %} {% endblock %}
{% block extra_head %}
{{ block.super }}
    <script type="text/javascript" src="{{MEDIA_URL}}turan/flot/jquery.flot.crosshair.js"></script>
{% with object.route.gpx_file as gpx_file %}
    {% include "turan/maphead.html" %}
{% endwith %}
{% endblock %}
{% block content %}
<h1>{% trans "Playback of exercise" %} {{ exercise }}</h1>
{% include "turan/altitude_profile.html" %}
<div>
<p class="graphheader speed floatleft">{% trans "Speed" %}
<br>
<span class="title" id="speedval"></span>
</p>
<div class="graph speed floatleft drop-shadow" id="speeddiv" style="width:130px;height:40px"></div>
<p class="graphheader hr floatleft">{% trans "HR" %}<br><span class="title" id="hrval"</span></p>
<div class="graph hr floatleft drop-shadow" id="hrdiv" style="width:130px;height:40px"></div>
{% if object.max_cadence %}
<p class="graphheader cadence floatleft">{% trans "Cadence" %}<br><span class="title" id="cadenceval"</span></p>
<div class="graph cadence floatleft drop-shadow" id="cadencediv" style="width:130px;height:40px"></div>
{% endif %}
<p class="graphheader altitude floatleft">{% trans "Altitude" %}<br><span class="title" id="altitudeval"</span></p>
<div class="graph altitude floatleft drop-shadow" id="altitudediv" style="width:130px;height:40px"></div>
{% if object.avg_power %}
<p class="graphheader power floatleft">{% trans "Power" %}<br><span class="title" id="powerval"</span></p>
<div class="graph power floatleft drop-shadow" id="powerdiv" style="width:130px;height:40px"></div>
{% endif %}
</div>
<script id="source" language="javascript" type="text/javascript">
    {% localize off %}
    var options = { 
        series: {
             lines: { show: false },
             bars: { 
                show: true,
                horizontal: true,
                fill: 1,
                barWidth: 1,
                align: "center"
             },
            xaxis: { tickDecimals: 0, tickSize: 1, tickLength: 1},
            yaxis: { tickDecimals: 0, tickSize: 1}
        },
        grid: {
            show: false,
            borderColor: '#000',
            borderWidth: 1,
            color: '#ffffff',
            markingsColor: "#000000",
            markingsLineWidth: 1,
            axisMargin: 0,
            labelMargin: 0
        }
    };

var datasets = {{ datasets }};
{% if object.avg_hr %}
var hroptions = $.extend(true, {}, options, { xaxis: {max: {{object.max_hr}}, min: 80}, grid: { markings: [ { yaxis: { from: {{object.avg_hr}}, to: {{object.avg_hr}}}}]} });
{% endif %}
{% if object.avg_speed %}
var speedoptions = $.extend(true, {}, options, { xaxis: {max: {{object.max_speed}}, min: 0 }});
{% endif %}
{% if object.max_cadence %}
var cadenceoptions = $.extend(true, {}, options, { xaxis: {max: {{object.max_cadence}}, min: 0}});
{% endif %}
var altitudeoptions = $.extend(true, {}, options, { xaxis: {max: {{alt_max}}, min: 0}});
{% if object.avg_power %}
var poweroptions = $.extend(true, {}, options, { xaxis: {max: {{object.max_power}}, min: 0}});
{% endif %}
var plots = {
};
/*
        'hr' : $.plot($("#hrdiv"),{ color: 2, data: datasets['hr']['data'].slice(index-1, index)}, hroptions),
        'speed' : $.plot($("#speeddiv"),[datasets['speed']['data'].slice(index-1, index)], speedoptions),
        'cadence' : $.plot($("#cadencediv"),[datasets['cadence']['data'].slice(index-1, index)], cadenceoptions),
        'power' :$.plot($("#powerdiv"),[datasets['power']['data'].slice(index-1, index)], poweroptions)
*/
$(document).ready(function() {

    //Mapper.gsat.setVisibility(1);
    Mapper.map.setBaseLayer(Mapper.gsat);
    // Focus le map
    $('#mapcontainer').focus();

    var updateInterval = 500;
    var zoomLevel = 15;
    var interval = 0;
    var index = 0;
    var mapUpdater = 0;
    var iterations = datasets["lon"].length;

    $('#altdiv').bind("plotclick", function (evt, pos, item) {
        index = item.dataIndex;
    });

    var updateMapAndGraph= function() {
        if (index >= iterations) {
            clearInterval(interval);
        }
        var lon = datasets["lon"][index];
        var lat = datasets["lat"][index];
        // Check for none-values, we don't want to zoom to 0_o o_0
        if (lon != 0.0 && lat != 0.0) {
            // Only move map every 4th sample, less cluttery looking
            if (mapUpdater >= 4) {
                Mapper.zoomToPosMarker();
                mapUpdater = 0;
            }
            Mapper.updatePosMarker(datasets["lon"][index],datasets["lat"][index]);
        }
        {% if object.avg_hr %}
            var hrval = datasets['hr']['data'][index][1];
            $('#hrval').html(hrval);
            plots['hr'] = $.plot($("#hrdiv"),[{ 'color': 2, 'data': [[hrval, 0]]}], hroptions);
        {% endif %}
        {% if object.avg_speed %}
            var speedval = datasets['speed']['data'][index][1];
            $('#speedval').html(speedval.toFixed(1));
            plots['speed'] = $.plot($("#speeddiv"),[{ 'color': 0, 'data': [[speedval, 0]]}], speedoptions);
        {% endif %}

            var altitudeval = datasets['altitude']['data'][index][1];
            $('#altitudeval').html(altitudeval.toFixed(0));
            plots['altitude'] = $.plot($("#altitudediv"),[{ 'color': 3, 'data': [[altitudeval, 0]]}], altitudeoptions);
        {% if object.max_cadence %}
            var cadenceval = datasets['cadence']['data'][index][1];
            $('#cadenceval').html(cadenceval.toFixed(0));
            plots['cadence'] = $.plot($("#cadencediv"),[{ 'color': 1, 'data': [[cadenceval, 0]]}], cadenceoptions);
        {% endif %}
        {% if object.avg_power %}
            var powerval = datasets['power']['data'][index][1];
            $('#powerval').html(powerval.toFixed(0));
            plots['power'] = $.plot($("#powerdiv"),[{ 'color': 4, 'data': [[powerval, 0]]}], poweroptions);
        {% endif %}
        
        // Unhighlight all previous points
        altitudeprofileplot.unhighlight();
        // Highlight the point at index in the first series in the altitudeprofile plot
        altitudeprofileplot.highlight(0, index);

        index = index+1;
        mapUpdater++;
    }

    interval = setInterval(updateMapAndGraph, updateInterval);
});

{% endlocalize %}
</script>
<div class="mapcontainer"><div style="width:1000px;height:1000px" class="drop-shadow raised" id="map"></div>

{% endblock content %}

