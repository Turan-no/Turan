{% extends "turan/base.html" %}
{% load humanize %}
{% load i18n %}
{% load turan_extras %}

{% load pagination_tags %}
{% load sorting_tags %}
{% block title %}
{% trans "Route" %} : {{object}} {% if object.distance %} {{ object.distance|floatformat }} km {% endif %}{% if object.ascent %} {{ object.ascent|floatformat }} asc m {% endif %}
{% endblock %}
{% block searchenginemeta %}
<meta name="description" content="{{object.description|truncatewords:20|escape}}" />
{% endblock %}
{% block extra_head %}
{{ block.super }}
{% with object.gpx_file as gpx_file %}
    {% include "turan/maphead.html" %}
{% endwith %}
{% endblock %}
{% block extramenu %}
{% if user.is_authenticated %}
        <li class="right"><a href="{% url route_update object.id %}">{% trans "Modify" %}</a></li>
{% endif %}
{% endblock %}
{% block content %}

<div style="width:500px; height:500px; float: right;" id="map"></div>
<h1>
    <a href="{{ object.get_absolute_url }}">{{ object.name }}</a>
</h1>
<div class="attributes spacer">
{% include "turan/route/attributes.html" %}
</div>
<ul class="photos hlist">
    {% for photo in object.get_photos %}
    <li>
        <a title="{{ photo.title }}" href="{{ photo.get_absolute_url }}">
            <img src="{{ photo.get_thumbnail_url }}" alt="{{ photo.title }}" />
        </a>
    </li>
    {% endfor %}
</ul>
<hr class="clearleft" />

{% comment %}
<ul class="buttons">
    <li>
    <a href="{% url trip_create %}">
        <img class="icons" src="{{ MEDIA_URL }}pinax/images/silk/icons/map_add.png" alt="{% trans "Add trip"%}" />
        {% trans "Add trip" %}
    </a>
    </li>
</ul>
{% endcomment %}
{% include "turan/tags.html" %}


{% with object.get_trips as object_list %}
{% autosort object_list %}
{% autopaginate object_list %}
{% if object_list %}
    <h3>{% trans "Average speed"%}</h3>
    <div id="avgspeeddiv" style="width:420px;height:200px"></div>
    <script id="source" language="javascript" type="text/javascript">
    $(function () {
            var times = [
            {% for user, series in usertimes.items %}
            {% if series %}
                {
                    label: "{{user}}",
                    data: [{{series}}],
                    color: {{ forloop.counter }}
                },
            {% endif %}
            {% endfor %}
    ];
    var options = { 
        xaxis: { mode: "time", timeformat: "%y/%m/%d" }, 
        yaxis: { min: 0, },
        legend: {
            position: "sw",
            noColumns: 0,
            },
        }
        $.plot($("#avgspeeddiv"), times, options);
    });
    </script>
    <h2 style="clear: both">{% trans "Altitude profile" %}</h2>
    <div id="altdiv" style="width:1000px;height:200px"></div>
<script id="source" language="javascript" type="text/javascript">
    var alt = { data: [{{ alt }}], color: 3, lines: { fill: 0.7 } };
    var options = { yaxes:[{}, { min: 0, max: {{ alt_max }}, }], };
$.plot($("#altdiv"), [alt], options);
</script>
    <form id="route_form">
    <h2>{% trans "Trips on this route" %}</h2>
    <input type="submit" value="{% trans "Compare"%}">
    <table class="fullsize">
        <tr>
            <th>{% trans "Select" %}</th>
            <th>{% anchor user Exerciser %}</th>
            <th>{% anchor duration %}</th>
            <th>{% anchor avg_hr "Avg HR" %}</th>
            <th>{% anchor avg_speed "Avg Speed" %}</th>
            <th>{% anchor date %}</th>
            <th>{% trans "Comment" %}</th>
        </tr>
        {% for object in object_list %}
        <tr>
	    <td><input type="checkbox" name="selected_routes" value="{{ object.id }}"></td>
            <td>{{ object.user }}</td>
            <td>{{ object.duration }}</td>
            <td>{{ object.avg_hr }} {% if object.avg_hr and object.user.get_profile.max_hr %} ({{ object.avg_hr|percent:object.user.get_profile.max_hr }}) {% endif %}</td>
            <td>{{ object.avg_speed|floatformat }}</td>
            <td><a href="{{ object.get_absolute_url }}">{{object.date|naturalday}}</a></td>
            <td>{{ object.comment|slice:"70" }}</td>
        </tr>
        {% endfor %}
    </table>
    </form>
    <script language="javascript" type="text/javascript">
    $('#route_form').bind("submit", function (ev) {
        ev.preventDefault();
        var selectedIds = [];
        $(this.selected_routes).each(function (i, elem) {
            if (elem.checked) {
                selectedIds.push(elem.value);
            }
        });
        // todo.. yea this code is real bad. *sighface*
        document.location = "/turan/exercise/compare/" + selectedIds.join("/");
    });
    </script>
{% paginate %}
{% endif %}
{% endwith %}
<hr>
{% include "turan/commentform.html" %}
{% endblock content %}

